<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        html {
            box-sizing: border-box;
            font-size: 62.5%;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            margin: 0;
            font-size: 1.6rem;
            font-family: 'Heebo', system-ui;
            text-shadow: 0px 1px 1px #7059e2;
        }

        canvas {
            background: black;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }

        a {
            color: inherit;
        }

        button,
        input,
        select,
        textarea {
            font-family: inherit;
        }

        button:focus,
        input:focus,
        select:focus,
        textarea:focus,
        button:active,
        input:active,
        select:active,
        textarea:active {
            outline: 0;
        }

        h1 {
            margin: 0;
        }

        h3 {
            margin: 4rem 0 3rem;
        }

        p {
            margin-bottom: 2rem;
        }

        .wrapper {
            margin: 4.5rem 1rem 0;
            position: absolute;
            z-index: 100;
            margin: 0;
        }

        #settingsModal {
            display: none;
            width: 100vw;
            height: 100vh;
        }

        .card {
            display: block;
            width: 100%;
            margin: auto;
            max-width: 1200px;
            background: #9c88ff;
            color: white;
            border-radius: 0.8rem;
            margin-bottom: 2rem;
        }

        .card__header {
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card__body {
            padding: 5rem 7rem 7rem;
        }

        @media screen and (max-width: 900px) {
            .card__body {
                padding: 5rem 2rem 7rem;
            }
        }

        .toolbar__item {
            box-shadow: inset 0px 0px 15px rgba(255, 255, 255, .5);
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: inline-block;
            cursor: pointer;
            transition: all 300ms ease;
        }

        .toolbar__item:not(:last-of-type) {
            margin-right: 0.5rem;
        }

        .toolbar__item:hover,
        .toolbar__item:focus {
            transform: scale(1.1);
            box-shadow: inset 0px 0px 3px rgba(255, 255, 255, .1);
            transition: all 300ms ease;
        }

        .toolbar__item--close {
            background: #ea6759;
        }

        .toolbar__item--min {
            background: #fc0;
        }

        .toolbar__item--max {
            background: #2dcc72;
        }

        .container {
            display: flex;
            width: 100%;
            flex-wrap: wrap;
            flex-direction: row;
            justify-content: space-between;
        }

        @media screen and (max-width: 900px) {
            .container {
                flex-direction: column;
            }
        }

        .grid {
            flex: 1;
            padding-left: 2rem;
            padding-right: 2rem;
            position: relative;
        }

        @media screen and (max-width: 900px) {
            .grid {
                max-width: 100%;
            }
        }

        .toggle {
            max-width: 62px;
            height: 32px;
            background: #7059e2;
            border-radius: 999px;
            position: relative;
            transition: all 300ms ease;
            cursor: pointer;
        }

        .toggle__handle {
            height: 24px;
            width: 24px;
            position: absolute;
            top: 50%;
            left: 4px;
            transform: translateY(-50%);
            background: white;
            border-radius: 50%;
            transition: all 300ms ease;
        }

        .toggle.is-on {
            background: white;
            transition: all 300ms ease;
        }

        .toggle.is-on .toggle__handle {
            left: 34px;
            background: #9c88ff;
            transition: all 300ms ease;
        }

        .form-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .form-item__control {
            width: 40%;
            text-align: right;
        }

        .form-item__date {
            width: 206px;
            text-align: right;
        }

        .control {
            position: relative;
            background: transparent;
            color: inherit;
            display: block;
            width: 100%;
            border-radius: 0.3rem;
            padding: 0.4rem;
            border: 1px solid rgba(255, 255, 255, .3);
        }

        .control:hover,
        .control:focus {
            background: #7059e2;
            border-color: transparent;
        }

        .radio {
            display: inline-block;
        }

        .radio__item {
            display: inline-block;
            color: #7059e2;
            cursor: pointer;
            transition: all 300ms ease;
        }

        .radio__item:not(:last-of-type) {
            margin-right: 1rem;
        }

        .radio__item.is-active {
            color: white;
            transition: all 300ms ease;
        }

        .u-text--xsmall {
            font-size: 1rem;
        }

        .u-text--small {
            font-size: 1.3rem;
        }

        .u-text--normal {
            font-size: 1.6rem;
        }

        .u-text--large {
            font-size: 1.9rem;
        }

        .u-text--xl {
            font-size: 2.2rem;
        }

        .slider {
            width: 100%;
            position: relative;
        }

        .slider__positive {
            width: 100%;
            height: 5px;
            background: white;
            position: absolute;
            top: 68%;
            /* Wtf */
            transform: translateY(-50%);
            pointer-events: none;
        }

        .slider__input {
            margin-top: 1rem;
            display: block;
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 5px;
            background: #7059e2;
            outline: none;
            transition: all 300ms ease;
        }

        .slider__input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 4px solid white;
            background: white;
            cursor: pointer;
            position: relative;
            transition: all 300ms ease;
        }

        .slider__input::-webkit-slider-thumb:focus,
        .slider__input::-webkit-slider-thumb:active {
            box-shadow: 0px 3px 12px rgba(0, 0, 0, .2);
            transition: all 300ms ease;
        }

        .button {
            border: 0;
            background: white;
            color: #9c88ff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            border-radius: 0.4rem;
            padding: 0.6rem 1.4rem;
            font-size: 1.4rem;
            line-height: 1;
            cursor: pointer;
        }

        .button:hover,
        .button:focus {
            background: #7059e2;
            color: white;
            transition: all 300ms ease;
        }

        .buttons {
            position: absolute;
            bottom: 0;
            right: 0;
            margin-top: 3rem;
        }

        .buttons .button {
            margin-left: 1rem;
        }

        .control--ol {
            display: grid;
            grid-template-columns: auto auto auto auto;
            border-color: transparent;
            list-style-type: none;
        }

        .control--ol:hover,
        .control--ol:focus {
            background: #9c88ff;
            border-color: transparent;
        }

        .color-display {
            max-width: 40px;
            height: 20px;
            background: #2dcc72;
            position: relative;
            border-radius: 0.8rem;
            margin: 5px 0;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0);
        }

        .color-display:hover,
        .color-display:focus {
            border: 2px solid rgba(255, 0, 0, .3);
        }
    </style>
</head>

<body>

    <div class="wrapper" id="settingsModal">
        <div class="card">
            <div class="card__header">
                <div class="toolbar">
                    <div class="toolbar__item toolbar__item--close" id="closeNoSave"></div>
                    <div class="toolbar__item toolbar__item--min"></div>
                    <div class="toolbar__item toolbar__item--max"></div>
                </div><a href="#">About</a>
            </div>
            <div class="card__body">
                <div class="container">
                    <div class="grid">
                        <h1>Settings</h1>
                    </div>
                </div>
                <div class="container">
                    <div class="grid grid--half">
                        <h3>Time</h3>
                        <div class="form-item"><label class="form-item__label">Remember Time</label>
                            <div class="form-item__control toggle">
                                <div class="toggle__handle"></div>
                            </div>
                        </div>
                        <div class="form-item"><label class="form-item__label">Countdown</label>
                            <div class="form-item__control toggle">
                                <div class="toggle__handle"></div>
                            </div>
                        </div>
                        <p><small>You should reduce the font size if enabled because the render is much larger and
                                likley wont fit on your original screen size.</small></p>
                        <div class="form-item"><label class="form-item__label">Countdown Date</label>
                            <div class="form-item__date">
                                <input class="control control--input" type="datetime-local" id="countdownDate">
                            </div>
                        </div>
                        <div class="form-item"><label class="form-item__label">Timer</label>
                            <div class="form-item__control">
                                <input class="control control--input" type="number" id="countdownTime" value="10">
                            </div>
                        </div>
                        <h3>Physics and Performance</h3>
                        <h5>Warning: Modifying these values will reinitialize your scene.</h5>
                        <div class="form-item"><label class="form-item__label">Particle Orbit Radius</label>
                            <div class="form-item__control"><small><strong><span
                                            class="slider__value">400</span></strong></small></div>
                            <div class="slider"><input class="slider__input" type="range" value="400" min="0" max="1000"
                                    id="orbitRadius" />
                                <div class="slider__positive" style="width: 50%;"></div>
                            </div>
                        </div>
                        <div class="form-item"><label class="form-item__label">Mouse Field Radius</label>
                            <div class="form-item__control"><small><strong><span
                                            class="slider__value">70</span></strong></small></div>
                            <div class="slider"><input class="slider__input" type="range" value="70" min="0" max="500"
                                    id="mouseIncrement" />
                                <div class="slider__positive" style="width: 50%;"></div>
                            </div>
                        </div>
                        <div class="form-item"><label class="form-item__label">Friction max</label>
                            <div class="form-item__control"><small><strong><span
                                            class="slider__value">85</span></strong></small>
                            </div>
                            <div class="slider"><input class="slider__input" type="range" value="85" min="0" max="100"
                                    id="frictionMax" />
                                <div class="slider__positive" style="width: 25%;"></div>
                            </div>
                        </div>
                        <div class="form-item"><label class="form-item__label">Friction min</label>
                            <div class="form-item__control"><small><strong><span
                                            class="slider__value">60</span></strong></small>
                            </div>
                            <div class="slider"><input class="slider__input" type="range" value="60" min="0" max="100"
                                    id="frictionMin" />
                                <div class="slider__positive" style="width: 25%;"></div>
                            </div>
                        </div>
                        <div class="form-item"><label class="form-item__label">Acceleration</label>
                            <div class="form-item__control"><small><strong>1/<span
                                            class="slider__value">20</span></strong></small>
                            </div>
                            <div class="slider"><input class="slider__input" type="range" value="20" min="1" max="1000"
                                    id="accelFactor" />
                                <div class="slider__positive" style="width: 25%;"></div>
                            </div>
                        </div>
                        <p><small>A larger acceleration will result in more snappy movements</small></p>
                        <div class="buttons"><a href="#">Extras</a><button class="button" id="closeSave">Done</button>
                        </div>
                    </div>
                    <div class="grid grid--half">
                        <h3>Customization</h3>
                        <div class="form-item"><label class="form-item__label">Text size</label>
                            <div class="form-item__control">
                                <div class="radio">
                                    <div class="radio__item" size="9"><span class="u-text--xsmall">A</span></div>
                                    <div class="radio__item" size="7"><span class="u-text--small">A</span></div>
                                    <div class="radio__item is-active" size="5"><span class="u-text--normal">A</span>
                                    </div>
                                    <div class="radio__item" size="4"><span class="u-text--large">A</span></div>
                                    <div class="radio__item" size="3"><span class="u-text--xl">A</span></div>
                                </div>
                            </div>
                        </div>
                        <p><small>Larger font sizes lead to more particles on screen which could reduce perfromance.
                                Accordingly, resizing the window is not recommended for similar reasons.
                            </small></p>
                        <div class="form-item"><label class="form-item__label">Particles</label>
                            <div class="form-item__control">
                                <input class="control control--input" type="number" id="particleCount" value="150">
                            </div>
                        </div>
                        <p><small>Larger values could use up large amounts of memory.</small></p>
                        <div class="form-item"><label class="form-item__label">End Text</label>
                            <div class="form-item__control">
                                <input class="control control--input" type="text" id="endText" value="Time's up">
                            </div>
                        </div>
                        <div class="form-item"><label class="form-item__label">Particle Radus Max</label>
                            <div class="form-item__control">
                                <input class="control control--input" type="number" id="particleRadusMax" value="4">
                            </div>
                        </div>
                        <div class="form-item"><label class="form-item__label">Particle Radus Min</label>
                            <div class="form-item__control">
                                <input class="control control--input" type="number" id="particleRadusMin" value="3">
                            </div>
                        </div>
                        <div class="form-item"><label class="form-item__label">Add color</label>
                            <div class="form-item__control">
                                <input class="control control--input" type="color" id="colorPicker">
                            </div>
                        </div>
                        <div class="form-item"><label class="form-item__label">Colors</label>
                            <div class="form-item__control">
                                <ol class="control control--ol" id="colorList"> </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <canvas id="scene"></canvas>
    <audio id="tickSound" src="https://assets.mixkit.co/active_storage/sfx/2568/2568.wav"></audio>
    <audio id="timerComplete" src="https://assets.mixkit.co/active_storage/sfx/2569/2569.wav"></audio>
    <script id="worker" type="javascript/worker">
        self.onmessage = function(e) {
          const particle = e.data.particle;
          const mouse = e.data.mouse;
          const mouseRadius = e.data.mouseRadius;
          const mouseIncrement = e.data.mouseIncrement;
          const accelFactor = e.data.accelFactor;
          const deltaTime = e.data.deltaTime;
      
          // Calculate new position
          let dx = (particle.dest.x - particle.x);
          let dy = (particle.dest.y - particle.y);
      
          particle.accX = dx * accelFactor;
          particle.accY = dy * accelFactor;
          particle.vx += particle.accX;
          particle.vy += particle.accY;
      
          particle.vx *= particle.friction;
          particle.vy *= particle.friction;
      
          particle.x += particle.vx * deltaTime;
          particle.y += particle.vy * deltaTime;
      
          // Mouse interaction
          let a = particle.x - mouse.x;
          let b = particle.y - mouse.y;
          let mouseDistance = Math.sqrt(a * a + b * b);
          if (mouseDistance < (mouseRadius * mouseIncrement)) {
              particle.accX = (particle.x - mouse.x) / 10;
              particle.accY = (particle.y - mouse.y) / 10;
              particle.vx += particle.accX;
              particle.vy += particle.accY;
          }
      
          self.postMessage({
              index: e.data.index,
              updatedParticle: particle
          });
        }
      </script>
    <script>

        var canvas = document.querySelector("#scene"),
            ctx = canvas.getContext("2d"),
            ww = canvas.width = window.innerWidth,
            wh = canvas.height = window.innerHeight,
            particles = [],
            amount = 0,
            mouse = { x: 0, y: 0 },
            totalExcess = 0,
            mouseRadius = 1,
            centerX = ww / 2,
            centerY = wh / 2,
            keepTime = false,
            timerPaused = false,
            tog = false,
            reInit = false,
            previousColor = "";
        var timeTxt;
        var endTime, msLeft, time;

        // <---------------------- Time ---------------------->
        var useEndDate = false, // Enable to count down to specific date
            // You will want to lower your font size for this
            mins = 10, //Normal Countdown Timer
            secs = 0;

        // <---------------------- Customization ---------------------->
        var fontSize = (ww / 5), //smaller sizes resolve quicker while larger require more friction
            particlesPer = 150, //decrese this for performance
            colors = ["rgb(201, 251, 255)", "rgb(194, 252, 247)", "rgb(133, 189, 191)", "rgb(87, 115, 122)",],
            endText = "Time's up",
            font = ["Montserrat",]; // you can put in multiple fonts
        // ex : font = ["Trebuchet MS", "Impact"];

        // <---------------------- Physics ---------------------->
        var mouseIncrement = 70,
            orbitRadius = 400; //Radius of the circe of particles around the time
        var accelFactor;//Turn up if particles are to slow
        var particleRadiusMax; // Max radius of each particle
        var particleRadiusMin; // Min radius of each particle
        var frictionMax // Turn these down if your particles arent forming
        var frictionMin // Turn them up if paticles arent getting to their destinations
        let lastFrameTime = performance.now();
        const TARGET_FRAMETIME = 1000 / 120;
        // <---------------------- Threads ---------------------->
        const NUM_WORKERS = navigator.hardwareConcurrency || 4;
        const workers = [];
        const particleQueue = [];
        let processingParticles = new Set();
        //<---------------------------------Menu--------------------------------->

        const countdownDate = document.getElementById('countdownDate');
        const countdownTime = document.getElementById('countdownTime');
        const particleCount = document.getElementById('particleCount');
        const olElement = document.getElementById('colorList');
        const toggle = document.querySelectorAll('.toggle');
        const orbitValue = document.getElementById('orbitRadius');
        const mouseIncrementDiv = document.getElementById('mouseIncrement')
        const endTextDiv = document.getElementById('endText');

        const accelFactorDiv = document.getElementById('accelFactor');
        accelFactor = (1 / accelFactorDiv.value);

        accelFactorDiv.addEventListener("change", (event) => {
            reInit = true;
        });

        const frictionMinDiv = document.getElementById('frictionMin');
        const frictionMaxDiv = document.getElementById('frictionMax');
        frictionMax = frictionMaxDiv.value / 100;
        frictionMin = frictionMinDiv.value / 100;

        frictionMinDiv.addEventListener("change", (event) => {
            reInit = true;
        });

        frictionMaxDiv.addEventListener("change", (event) => {
            reInit = true;
        });

        const particleRadiusMaxDiv = document.getElementById('particleRadusMax');
        const particleRadiusMinDiv = document.getElementById('particleRadusMin');

        particleRadiusMax = particleRadiusMaxDiv.value;
        particleRadiusMin = particleRadiusMinDiv.value;


        particleRadiusMaxDiv.addEventListener("change", (event) => {
            reInit = true;
        });

        particleRadiusMinDiv.addEventListener("change", (event) => {
            reInit = true;
        });

        particleRadiusMinDiv.addEventListener('focus', function () {
            tog = !tog;
            let color = colorPicker.value;
            if (tog === true) { //open
                previousColor = color;
            } else { //close
                if (previousColor != color) {
                    createColorLi(color);
                    reInit = true;
                }
            }
        });

        const colorPicker = document.getElementById('colorPicker');

        colorPicker.addEventListener('focus', function () {
            tog = !tog;
            let color = colorPicker.value;
            if (tog === true) { //open
                previousColor = color;
            } else { //close
                if (previousColor != color) {
                    createColorLi(color);
                    reInit = true;
                }
            }
        });

        // Switches
        for (let i = 0; toggle.length > i; i++) {
            if (i === 0) {
                toggle[i].addEventListener('click', function () {
                    this.classList.toggle('is-on');
                    keepTime = !keepTime;
                })
            }
            else if (i === 1) {
                toggle[i].addEventListener('click', function () {
                    this.classList.toggle('is-on');
                    useEndDate = !useEndDate;
                })
            }


        }

        const radioItem = document.querySelectorAll('.radio__item');

        for (let i = 0; radioItem.length > i; i++) {
            radioItem[i].addEventListener('click', function () {
                const siblingItems = this.parentNode.getElementsByClassName('radio__item');

                for (let i = 0; siblingItems.length > i; i++) {
                    siblingItems[i].classList.remove('is-active');
                }
                this.classList.toggle('is-active');
                fontSize = (ww / Number(this.getAttribute('size')));
            });
        }

        const sliderInput = document.querySelectorAll('.slider__input');

        for (let i = 0; sliderInput.length > i; i++) {
            sliderInput[i].addEventListener('input', function () {
                const valueContainer = this.parentNode.parentNode.querySelector('.slider__value');
                const sliderValue = this.value;
                const maxVal = this.getAttribute('max');
                const minVal = this.getAttribute('min');
                const posWidth = this.value / (maxVal - minVal);
                this.parentNode.querySelector('.slider__positive').style.width = (posWidth * 100) + '%';
                valueContainer.innerHTML = sliderValue;
            });
        }

        function removeColorAndElement(liElement) {
            var divElement = liElement.firstChild;
            var colorToRemove = divElement.style.backgroundColor;
            var indexToRemove = colors.indexOf(colorToRemove);
            colors.splice(indexToRemove, 1);


            olElement.removeChild(liElement);
            reInit = true;
        }

        function initColorArray() {
            for (let i = 0; i < colors.length; i++) {
                createColorLi(colors[i], false);
            }
        }

        function createColorLi(color, push = true) {
            if (push) {
                colors.push(color)
            }
            var liElement = document.createElement('li');
            var divElement = document.createElement('div'); // Create a new div
            divElement.classList.add('color-display'); // Add the 'color-display' class
            divElement.style.backgroundColor = color; // Set the background color
            divElement.addEventListener('click', function () {
                removeColorAndElement(this.parentNode);
            });
            liElement.appendChild(divElement); // Append the div to the list item
            olElement.appendChild(liElement); // Append the list item to the ordered list
        }
        const closeNoSave = document.getElementById('closeNoSave');
        const closeSave = document.getElementById('closeSave');
        closeNoSave.addEventListener('click', menuToggle)
        closeSave.addEventListener('click', saveAndClose)

        function saveAndClose() {
            particlesPer = particleCount.value;
            endText = endTextDiv.value;
            orbitRadius = orbitValue.value;
            mouseIncrement = mouseIncrementDiv.value;
            particleRadiusMax = particleRadiusMaxDiv.value;
            particleRadiusMin = particleRadiusMinDiv.value;
            frictionMax = frictionMaxDiv.value / 100;
            frictionMin = frictionMinDiv.value / 100;
            accelFactor = (1 / accelFactorDiv.value);
            countdown(countdownTime.value, 0);
            menuToggle();
            if (reInit) initScene();
            reInit = false;
        }


        // Initialize workers
        function initializeWorkers() {
            console.log(document.querySelector('#worker'));
            const workerScript = document.querySelector('#worker').textContent;
            const blob = new Blob([workerScript], { type: 'text/javascript' });
            const workerUrl = URL.createObjectURL(blob);

            for (let i = 0; i < NUM_WORKERS; i++) {
                const worker = new Worker(workerUrl);
                worker.onmessage = handleWorkerMessage;
                workers.push(worker);
            }
        }

        function handleWorkerMessage(e) {
            const { index, updatedParticle } = e.data;
            const p = particles[index];

            // Update only the calculated properties
            p.x = updatedParticle.x;
            p.y = updatedParticle.y;
            p.vx = updatedParticle.vx;
            p.vy = updatedParticle.vy;
            p.accX = updatedParticle.accX;
            p.accY = updatedParticle.accY;

            processingParticles.delete(index);

            if (particleQueue.length > 0) {
                const nextIndex = particleQueue.shift();
                processParticle(nextIndex);
            }
        }

        function processParticle(index) {
            if (processingParticles.has(index)) return;

            processingParticles.add(index);
            const worker = workers[index % NUM_WORKERS];
            const p = particles[index];

            worker.postMessage({
                index: index,
                particle: {
                    x: p.x,
                    y: p.y,
                    dest: p.dest,
                    vx: p.vx,
                    vy: p.vy,
                    accX: p.accX,
                    accY: p.accY,
                    friction: p.friction,
                    excessIndex: p.excessIndex,
                    color: p.color,
                    r: p.r
                },
                mouse: mouse,
                mouseRadius: mouseRadius,
                mouseIncrement: mouseIncrement,
                accelFactor: accelFactor,
                deltaTime: performanceStats.deltaTime
            });
        }




        //<---------------------------------Timer--------------------------------->

        function Particle(x, y) {
            this.x = (Math.random() - 0.5) * ww + ww / 2
            this.y = (Math.random() - 0.5) * wh + wh / 2
            this.dest = {
                x: x,
                y: y
            };
            this.r = (Math.random() * (particleRadiusMax - particleRadiusMin)) + Number(particleRadiusMin);
            this.vx = (Math.random() - 5.5) * 15;
            this.vy = (Math.random() - 5.5) * 15;
            this.accX = 0;
            this.accY = 0;
            this.friction = Math.random() * (frictionMax - frictionMin) + frictionMin;
            this.excessIndex = -1;
            this.color = colors[Math.floor(Math.random() * colors.length)];

            this.leave = function () {
                if (this.excessIndex != -1) {
                    let angle = ((2 * Math.PI) / totalExcess) * this.excessIndex;
                    this.dest.x = centerX + orbitRadius * Math.cos(angle);
                    this.dest.y = centerY + orbitRadius * Math.sin(angle);
                }
                else {
                    alert(this.excessIndex);
                }

            };

            this.setpoint = function (x, y) {
                this.dest.x = x;
                this.dest.y = y;
            };

            this.distanceFrom = function (x, y) {
                return Math.sqrt(((x - this.x) ** 2) + ((y - this.y) ** 2));
            }

            this.speed = function () {
                return Math.sqrt(((this.vx) ** 2) + ((this.vy) ** 2));
            }
        }

        //Particle render

        Particle.prototype.render = function () {
            const physicsStart = performance.now();

            let dx = (this.dest.x - this.x);
            let dy = (this.dest.y - this.y);

            this.accX = dx * accelFactor;
            this.accY = dy * accelFactor;
            this.vx += this.accX;
            this.vy += this.accY;

            this.vx *= this.friction;
            this.vy *= this.friction;

            this.x += this.vx * performanceStats.deltaTime;
            this.y += this.vy * performanceStats.deltaTime;

            let a = this.x - mouse.x;
            let b = this.y - mouse.y;
            let mouseDistance = Math.sqrt(a * a + b * b);
            if (mouseDistance < (mouseRadius * mouseIncrement)) {
                this.accX = (this.x - mouse.x) / 10;
                this.accY = (this.y - mouse.y) / 10;
                this.vx += this.accX;
                this.vy += this.accY;
            }

            performanceStats.physicsTime = performance.now() - physicsStart;

            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.r, Math.PI * 2, false);
            ctx.fill();
        }




        function onMouseMove(e) {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        }

        function onTouchMove(e) {
            if (e.touches.length > 0) {
                mouse.x = e.touches[0].clientX;
                mouse.y = e.touches[0].clientY;
            }
        }

        function onTouchEnd(e) {
            mouse.x = -9999;
            mouse.y = -9999;
        }

        function initScene() {

            ww = canvas.width = window.innerWidth;
            wh = canvas.height = window.innerHeight;
            centerX = ww / 2;
            centerY = wh / 2;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.font = "bold " + fontSize + "px " + getFont();
            ctx.textAlign = "center";
            ctx.fillText(timeTxt, ww / 2, (wh + fontSize / 2) / 2);
            var data = ctx.getImageData(0, 0, ww, wh).data;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = "screen";

            particles = [];
            for (let i = 0; i < ww; i += Math.round(ww / particlesPer)) {
                for (let j = 0; j < wh; j += Math.round(ww / particlesPer)) {
                    if (data[((i + j * ww) * 4) + 3] > particlesPer) {
                        particles.push(new Particle(i, j));
                    }
                }
            }
            amount = particles.length;

        }

        function onMouseClick() {
            if (!timerPaused) {
                mouseRadius++;
                if (mouseRadius === 5) {
                    mouseRadius = 0;
                }
            }
        }

        function updateText() {
            let n = 0;
            let excess = 0;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = "bold " + fontSize + "px " + getFont();
            ctx.fillText(timeTxt, ww / 2, (wh + fontSize / 2) / 2);
            var data = ctx.getImageData(0, 0, ww, wh).data;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < ww; i += Math.round(ww / particlesPer)) {
                for (let j = 0; j < wh; j += Math.round(ww / particlesPer)) {
                    if (data[((i + j * ww) * 4) + 3] > particlesPer) {
                        if (n < amount) {
                            particles[n].setpoint(i, j);
                            particles[n].excessIndex = -1;
                        }
                        else {
                            particles.push(new Particle(i, j));
                        }
                        n++;
                    }
                }
            }
            totalExcess = particles.length - n;
            while (n < amount) {
                particles[n].excessIndex = excess;
                particles[n].leave();
                excess++;
                n++;
            }

            amount = particles.length;
        }

        function render(a) {
            const renderStart = performance.now();
            performanceStats.physicsTime = 0; // Reset physics time

            requestAnimationFrame(render);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let i = 0; i < amount; i++) {
                if (!processingParticles.has(i)) {
                    if (workers.length > processingParticles.size) {
                        processParticle(i);
                    } else {
                        particleQueue.push(i);
                    }
                }
                particles[i].render();
            }

            performanceStats.renderTime = performance.now() - renderStart;
            performanceStats.particleCount = amount;
        }



        function countdown(minutes, seconds) {
            if (!keepTime) {
                if (!useEndDate) {
                    endTime = (+new Date) + 1000 * (60 * minutes + seconds) + 500;
                }
                else {
                    endTime = new Date(countdownDate.value);
                }
            }
            updateTimer();
        }

        function updateTimer() {
            if (!timerPaused) {
                msLeft = endTime - (+new Date);

                let secondsLeft = Math.floor(msLeft / 1000);

                if (secondsLeft <= 10 && secondsLeft >= 1) {
                    document.getElementById('tickSound').play();
                }

                if (msLeft < 1000) {
                    timeTxt = endText;
                    document.getElementById('timerComplete').play();
                } else {
                    time = new Date(msLeft);
                    hours = time.getUTCHours();
                    mins = time.getUTCMinutes();
                    if (!useEndDate) {
                        timeTxt = (hours ? hours + ':' + twoDigits(mins) : mins) + ':' + twoDigits(time.getUTCSeconds());
                    } else {
                        timeTxt = formatDuration(new Date(countdownDate.value));
                    }
                    setTimeout(updateTimer, time.getUTCMilliseconds() + 500);
                }
                updateText();
            }
        }

        function formatDuration(dateObject) {
            var totalSeconds = Math.floor((dateObject.getTime() - Date.now()) / 1000);
            var days = Math.floor(totalSeconds / (60 * 60 * 24));
            var hours = Math.floor((totalSeconds % (60 * 60 * 24)) / (60 * 60));
            var minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
            var seconds = totalSeconds % 60;

            var result = '';
            if (days > 0) result += days + 'd ';
            if (hours > 0) result += twoDigits(hours) + 'h ';
            if (minutes > 0) result += twoDigits(minutes) + 'm ';
            result += twoDigits(seconds) + 's';

            return result.trim();
        }

        function twoDigits(n) {
            return (n <= 9 ? "0" + n : n);
        }

        function getFont() {
            return font[(Math.floor(Math.random() * font.length))]
        }

        function menuToggle(e) {
            if (e) e.preventDefault();


            if (!timerPaused) {
                document.getElementById('settingsModal').style.display = 'block';
                timerPaused = true;
            }
            else {
                document.getElementById('settingsModal').style.display = 'none';

                if (timerPaused) {
                    timerPaused = false;
                    updateTimer();
                }
            }

            return true;
        }

        // <---------------------- Performance ----------------------->

        const performanceStats = {
            fps: 0,
            deltaTime: 0,
            particleCount: 0,
            renderTime: 0,
            physicsTime: 0
        };

        function measurePerformance() {
            const stats = document.createElement('div');
            stats.style.position = 'fixed';
            stats.style.top = '10px';
            stats.style.left = '10px';
            stats.style.color = 'white';
            stats.style.fontFamily = 'monospace';
            document.body.appendChild(stats);

            let lastTime = performance.now();
            lastFrameTime = lastTime;
            let frames = 0;

            function update() {
                const now = performance.now();
                frames++;
                performanceStats.deltaTime = (now - lastFrameTime) / 24;
                lastFrameTime = now;
                if (now >= lastTime + 1000) {
                    performanceStats.fps = frames;
                    frames = 0;
                    lastTime = now;

                    const renderDisplay = performanceStats.renderTime < 1 ? '<1' : Math.round(performanceStats.renderTime);
                    const physicsDisplay = performanceStats.physicsTime < 1 ? '<1' : Math.round(performanceStats.physicsTime);

                    stats.textContent = `
                FPS: ${performanceStats.fps}
                Particles: ${performanceStats.particleCount}
                Render: ${renderDisplay}ms
                Physics: ${physicsDisplay}ms
            `;
                }
                requestAnimationFrame(update);
            }
            update();
        }


        measurePerformance();
        window.addEventListener("resize", initScene);
        window.addEventListener("mousemove", onMouseMove);
        window.addEventListener("touchmove", onTouchMove);
        window.addEventListener("click", onMouseClick);
        window.addEventListener("touchend", onTouchEnd);
        canvas.addEventListener("contextmenu", menuToggle);
        countdown(mins, secs);
        initScene();
        initColorArray();
        sliderInput.forEach((e) => e.dispatchEvent(new CustomEvent("input", {})));
        initializeWorkers();
        requestAnimationFrame(render);
    </script>

</body>

</html>